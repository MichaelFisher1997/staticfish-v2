---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import { ArrowRight } from 'lucide-react';
import { getAllPosts } from '../lib/sanity';
import type { Post } from '../types/post';

// Fetch all posts from Sanity
const posts = await getAllPosts().catch(error => {
  console.error('Error fetching posts:', error);
  return [];
});
---

<Layout title="Blog Posts - Staticfish">
  <div class="min-h-screen flex flex-col">
    <Header />
    <main class="flex-1">
      <div class="bg-background py-24 sm:py-32">
        <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <!-- Header -->
          <div class="mx-auto max-w-2xl text-center">
            <h1 class="text-4xl font-bold tracking-tight text-foreground sm:text-5xl mb-6">
              Our Blog
            </h1>
            <p class="mt-2 text-lg leading-8 text-muted-foreground">
              Latest insights, news, and updates from Staticfish.
            </p>
          </div>
          
          <!-- Posts Grid -->
          <div class="mx-auto mt-16 grid max-w-2xl grid-cols-1 gap-x-8 gap-y-12 lg:mx-0 lg:max-w-none lg:grid-cols-3">
            {posts.length > 0 ? (
              posts.map((post: Post) => (
                <Card className="flex flex-col overflow-hidden hover:shadow-lg transition-shadow border-border bg-card h-full">
                  {post.mainImage && (
                    <div class="relative h-48 w-full overflow-hidden">
                      <img 
                        src={`${post.mainImage.asset._ref.replace('image-', 'https://cdn.sanity.io/images/2gr3dh6t/production/').replace('-jpg', '.jpg').replace('-png', '.png').replace('-webp', '.webp')}`} 
                        alt={post.title} 
                        class="absolute inset-0 h-full w-full object-cover"
                      />
                    </div>
                  )}
                  <CardHeader>
                    <div class="flex items-center justify-between gap-x-4 text-xs mb-2">
                      <time datetime={post.publishedAt} class="text-muted-foreground">
                        {new Date(post.publishedAt).toLocaleDateString('en-US', {
                          year: 'numeric',
                          month: 'short',
                          day: 'numeric',
                        })}
                      </time>
                      {post.categories && post.categories.length > 0 && (
                        <div class="flex gap-x-2">
                          {post.categories.map(category => (
                            <span class="bg-muted text-muted-foreground rounded-full px-3 py-1.5 font-medium">
                              {category}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                    <CardTitle className="text-xl">
                      {post.title}
                    </CardTitle>
                    {post.excerpt && (
                      <CardDescription className="line-clamp-3 mt-2">
                        {post.excerpt}
                      </CardDescription>
                    )}
                  </CardHeader>
                  <CardContent className="mt-auto pt-0">
                    <div class="flex mt-4 items-center">
                      <Button variant="link" className="flex items-center p-0">
                        <a href={`/posts/${post.slug.current}`} class="flex items-center">
                          Read post
                          <ArrowRight className="ml-2 h-4 w-4" />
                        </a>
                      </Button>
                      {post.author && (
                        <div class="ml-auto text-sm text-muted-foreground">
                          By {post.author}
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              ))
            ) : (
              <div class="col-span-1 lg:col-span-3 text-center">
                <p class="text-muted-foreground text-lg">
                  No posts found. Check back soon for new content!
                </p>
              </div>
            )}
          </div>
        </div>
      </div>
    </main>
    <Footer />
  </div>
</Layout>
