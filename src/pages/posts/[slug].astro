---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { Button } from '../../components/ui/button';
import { getPostBySlug } from '../../lib/sanity';

// Get the slug from the URL
const { slug } = Astro.params;

// Fetch the post data using the slug
const post = await getPostBySlug(slug).catch(error => {
  console.error(`Error fetching post with slug "${slug}":`, error);
  return null;
});

// If post not found, redirect to posts listing page
if (!post) {
  return Astro.redirect('/posts');
}

// Format date
const formattedDate = new Date(post.publishedAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout title={`${post.title} - Staticfish`}>
  <div class="min-h-screen flex flex-col">
    <Header />
    <main class="flex-1">
      <article class="bg-background py-16 sm:py-24">
        <div class="container mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
          <!-- Post Header -->
          <header class="mb-10">
            <div class="flex items-center gap-x-4 text-xs mb-4">
              <time datetime={post.publishedAt} class="text-muted-foreground">
                {formattedDate}
              </time>
              {post.categories && post.categories.length > 0 && (
                <div class="flex gap-x-2">
                  {post.categories.map((category: string) => (
                    <span class="bg-muted text-muted-foreground rounded-full px-3 py-1.5 font-medium">
                      {category}
                    </span>
                  ))}
                </div>
              )}
            </div>
            <h1 class="text-3xl font-bold tracking-tight text-foreground sm:text-4xl mb-4">
              {post.title}
            </h1>
            {post.author && (
              <div class="text-muted-foreground">
                By {post.author}
              </div>
            )}
          </header>

          <!-- Featured Image -->
          {post.mainImage && (
            <div class="relative h-64 sm:h-96 w-full overflow-hidden mb-10 rounded-lg">
              <img 
                src={`${post.mainImage.asset._ref.replace('image-', 'https://cdn.sanity.io/images/2gr3dh6t/production/').replace('-jpg', '.jpg').replace('-png', '.png').replace('-webp', '.webp')}`} 
                alt={post.title} 
                class="h-full w-full object-cover"
              />
            </div>
          )}

          <!-- Post Content -->
          <div class="prose prose-lg prose-slate max-w-none">
            {/* Render Portable Text content - this is simplified 
                For complete rendering, you may want to use @portabletext/react */}
            {post.body && 
              post.body.map((block: any) => {
                if (block._type === 'block' && block.style === 'normal') {
                  return <p class="mb-4 text-muted-foreground leading-relaxed">{block.children[0]?.text || ''}</p>
                }
                if (block._type === 'block' && block.style === 'h2') {
                  return <h2 class="text-2xl font-bold mt-8 mb-4">{block.children[0]?.text || ''}</h2>
                }
                if (block._type === 'block' && block.style === 'h3') {
                  return <h3 class="text-xl font-bold mt-6 mb-3">{block.children[0]?.text || ''}</h3>
                }
                return null;
              })
            }
          </div>

          <!-- Back Button -->
          <div class="mt-12 border-t border-border pt-6">
            <Button variant="outline">
              <a href="/posts" class="flex items-center">
                Back to all posts
              </a>
            </Button>
          </div>
        </div>
      </article>
    </main>
    <Footer />
  </div>
</Layout>
